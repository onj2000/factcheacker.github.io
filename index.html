<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIãƒ¡ãƒ‡ã‚£ã‚¢åˆ¤åˆ¥ï¼†ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚«ãƒ¼</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
    }
    .card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
    }
    textarea { resize: vertical; }
    .loading-spinner {
      border-top-color: #ffffff;
      -webkit-animation: spinner 1s linear infinite;
      animation: spinner 1s linear infinite;
    }
    @keyframes spinner {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .source-list {
        margin-top: 1rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e5e7eb;
    }
    .source-item {
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
  </style>
</head>
<body class="p-4">
  <main class="max-w-3xl mx-auto space-y-8">
    <h1 class="text-3xl font-extrabold text-gray-900 text-center">âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚«ãƒ¼</h1>
    <p><a href="cheack2.html">â†’æ–°ç‰ˆã¯ã“ã¡ã‚‰</a></p>
    
    <!-- 1. ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ (Gemini + Google Search) ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="card space-y-4 border-t-4 border-indigo-600">
        <h2 class="text-xl font-bold text-indigo-700">æƒ…å ±ã®çœŸå½åˆ¤å®š (Gemini + Google Search)</h2>
        
        <input id="geminiKey" type="password" placeholder="Google Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ› (å¿…é ˆ)" 
               class="w-full border border-gray-300 p-3 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
        
        <!-- æ–™é‡‘ãƒ»APIå–å¾—æ–¹æ³•ã«é–¢ã™ã‚‹èª¬æ˜ -->
        <div class="text-xs p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-gray-700">
            <p class="font-semibold text-indigo-800">ğŸ’¡ Gemini APIã®åˆ©ç”¨ã¨æ–™é‡‘ã«é–¢ã™ã‚‹æ³¨æ„äº‹é …</p>
            <ul class="list-disc list-inside ml-2 space-y-1 mt-1">
                <li>æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯**Google Searché€£æºæ©Ÿèƒ½**ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ç„¡æ–™æ ã‚’è¶…éã—ãŸå ´åˆã€**èª²é‡‘ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§**ãŒã‚ã‚Šã¾ã™ã€‚</li>
                <li>APIã‚­ãƒ¼ã¯ã€<a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" class="text-indigo-600 hover:underline">Google AI Studio</a>ã§å–å¾—ã—ã€ã”è‡ªèº«ã®è²¬ä»»ã§ç®¡ç†ã—ã¦ãã ã•ã„ã€‚</li>
            </ul>
        </div>
        
        <textarea id="inputText" rows="4" placeholder="çœŸå½ã‚’ç¢ºèªã—ãŸã„æ–‡ç« ã‚„ã€æœ€æ–°ã®æƒ…å ±ãŒå¿…è¦ãªè³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚" 
                  class="w-full border border-gray-300 p-3 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"></textarea>
        
        <button id="factCheckBtn" class="analyze-btn w-full bg-indigo-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150 flex items-center justify-center disabled:opacity-50">
            <span id="checkText">ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ</span>
            <div id="checkLoading" class="hidden w-5 h-5 border-2 border-solid rounded-full loading-spinner border-r-transparent ml-2"></div>
        </button>

        <p class="text-sm font-semibold text-gray-700 mt-4">ãƒã‚§ãƒƒã‚¯çµæœ:</p>
        <div id="outputContainer" class="bg-gray-50 border border-gray-200 p-4 rounded-lg text-sm text-gray-800">
            <pre id="output" class="whitespace-pre-wrap"></pre>
            <div id="sources" class="source-list hidden">
                <p class="font-bold text-xs text-gray-600 mb-2">ã€å‚ç…§å…ƒæƒ…å ±ã€‘</p>
            </div>
        </div>
    </div>

    <!-- 2. ç”»åƒç”Ÿæˆ (Hugging Face) ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (å‰å›ã‹ã‚‰ã®å¤‰æ›´ãªã—) -->
    <div class="card space-y-4 border-t-4 border-green-500">
        <h2 class="text-xl font-bold text-green-600">ç”»åƒç”Ÿæˆ (Stable Diffusion)</h2>
        <input id="hfKey" type="password" placeholder="Hugging Face APIã‚­ãƒ¼ã‚’å…¥åŠ› (å¿…é ˆ)" 
               class="w-full border border-gray-300 p-3 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm">

        <div class="text-xs p-3 bg-green-50 border border-green-200 rounded-lg text-gray-700">
            <p class="font-semibold text-green-700">ğŸ’¡ Hugging Face APIã‚­ãƒ¼ã«ã¤ã„ã¦</p>
            <ul class="list-disc list-inside ml-2 space-y-1 mt-1">
                <li>Hugging Faceã®APIã‚­ãƒ¼ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã¯ã€<a href="https://huggingface.co/settings/tokens" target="_blank" class="text-green-600 hover:underline">Settings &gt; Access Tokens</a>ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚</li>
                <li>ç„¡æ–™ãƒ¢ãƒ‡ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ãŒã€é«˜é »åº¦ã®åˆ©ç”¨ã‚„å®‰å®šæ€§ã‚’æ±‚ã‚ã‚‹å ´åˆã¯æœ‰æ–™ãƒ—ãƒ©ãƒ³ãŒå¿…è¦ã§ã™ã€‚</li>
            </ul>
        </div>
        
        <input id="prompt" placeholder="ç”Ÿæˆã—ãŸã„ç”»åƒã®èª¬æ˜ã‚’å…¥åŠ› (ä¾‹: å®‡å®™ã‚’æ—…ã™ã‚‹çŒ«)" 
               class="w-full border border-gray-300 p-3 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm">
        
        <button id="imgBtn" class="generate-btn w-full bg-green-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:bg-green-700 transition duration-150 flex items-center justify-center disabled:opacity-50">
            <span id="imgText">ç”»åƒç”Ÿæˆ (Hugging Face)</span>
            <div id="imgLoading" class="hidden w-5 h-5 border-2 border-solid rounded-full loading-spinner border-r-transparent ml-2"></div>
        </button>
        <p class="text-xs text-yellow-600 bg-yellow-50 p-2 rounded-lg border border-yellow-200">
            âš ï¸ Hugging Faceã®ç„¡æ–™ãƒ¢ãƒ‡ãƒ«ã¯å¿œç­”ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã‹ã€å¤±æ•—ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
        </p>

        <img id="imageResult" alt="ç”Ÿæˆã•ã‚ŒãŸç”»åƒ" class="mt-4 rounded-lg shadow-xl w-full hidden border border-gray-300">
    </div>
  </main>
  
  <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« (alertã®ä»£æ›¿) -->
  <div id="customModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-50">
    <div class="relative p-6 bg-white w-96 rounded-xl shadow-2xl transform transition-all scale-100">
        <h3 id="modalTitle" class="text-xl font-bold text-red-600 border-b pb-2 mb-3">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
        <p id="modalMessage" class="text-gray-700 whitespace-pre-wrap"></p>
        <button onclick="document.getElementById('customModal').classList.add('hidden')" 
                class="mt-6 w-full py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition shadow-md">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    // --- å®šæ•°ã¨DOMè¦ç´  ---
    const MODEL_GEMINI = "gemini-2.5-flash-preview-09-2025";
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/" + MODEL_GEMINI + ":generateContent?key=";
    const HF_MODEL = "stabilityai/stable-diffusion-2"; 

    const geminiKeyInput = document.getElementById('geminiKey');
    const hfKeyInput = document.getElementById('hfKey');
    const inputText = document.getElementById('inputText');
    const promptInput = document.getElementById('prompt');
    const output = document.getElementById('output');
    const outputContainer = document.getElementById('outputContainer');
    const sourcesDiv = document.getElementById('sources');
    const imageResult = document.getElementById('imageResult');
    const factCheckBtn = document.getElementById('factCheckBtn');
    const imgBtn = document.getElementById('imgBtn');
    const checkText = document.getElementById('checkText');
    const imgText = document.getElementById('imgText');
    const checkLoading = document.getElementById('checkLoading');
    const imgLoading = document.getElementById('imgLoading');

    /**
     * ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° (alertã®ä»£æ›¿)
     */
    function showModal(title, message, colorClass = 'text-red-600') {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalTitle').className = `text-xl font-bold border-b pb-2 mb-3 ${colorClass}`;
        document.getElementById('modalMessage').textContent = message;
        modal.classList.remove('hidden');
    }
    
    /**
     * ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
     */
    function setLoading(btn, textSpan, loadingIndicator, isLoading, originalText) {
        btn.disabled = isLoading;
        if (isLoading) {
            textSpan.textContent = "ãƒã‚§ãƒƒã‚¯ä¸­...";
            loadingIndicator.classList.remove('hidden');
            btn.classList.add('bg-gray-500', 'hover:bg-gray-500');
            btn.classList.remove('hover:bg-indigo-700'); // å¤‰æ›´
        } else {
            textSpan.textContent = originalText;
            loadingIndicator.classList.add('hidden');
            btn.classList.remove('bg-gray-500', 'hover:bg-gray-500');
            btn.classList.add('hover:bg-indigo-700'); // å¤‰æ›´
        }
    }

    /**
     * APIå‘¼ã³å‡ºã—ã¨æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•å‡¦ç†
     */
    async function fetchWithBackoff(url, options) {
        const MAX_RETRIES = 3;
        for (let i = 0; i < MAX_RETRIES; i++) {
            try {
                const response = await fetch(url, options);
                return response;
            } catch (error) {
                if (i === MAX_RETRIES - 1) throw new Error("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼: " + error.message);
                const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }

    /**
     * ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•° (Gemini + Google Search)
     */
    async function runFactChecker() {
        const key = geminiKeyInput.value.trim();
        const text = inputText.value.trim();
        imageResult.classList.add("hidden");
        output.textContent = "";
        sourcesDiv.classList.add("hidden");
        sourcesDiv.innerHTML = '<p class="font-bold text-xs text-gray-600 mb-2">ã€å‚ç…§å…ƒæƒ…å ±ã€‘</p>';

        if (!key) return showModal("ã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼", "Google Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", 'text-red-600');
        if (!text) return showModal("å…¥åŠ›ã‚¨ãƒ©ãƒ¼", "ãƒã‚§ãƒƒã‚¯ã—ãŸã„æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", 'text-yellow-600');
        
        setLoading(factCheckBtn, checkText, checkLoading, true, 'ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ');
        output.textContent = "ğŸ”„ æ¤œç´¢ã¨åˆ†æã‚’å®Ÿè¡Œä¸­... (Gemini)";

        try {
            const url = GEMINI_API_URL + key;
            const systemPrompt = "ã‚ãªãŸã¯ã€Googleæ¤œç´¢ã®çµæœã«åŸºã¥ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæä¾›ã—ãŸæƒ…å ±ã®çœŸå½ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚æƒ…å ±ãŒçœŸå®Ÿã‹è™šå½ã‹ã€ã¾ãŸã¯æ–­å®šã§ããªã„ã‹ã‚’æ˜ç¢ºã«åˆ¤æ–­ã—ã€ãã®æ ¹æ‹ ã¨ãªã£ãŸæƒ…å ±ã‚’å¼•ç”¨å…ƒã¨å…±ã«æç¤ºã—ã¦ãã ã•ã„ã€‚å¼•ç”¨å…ƒãŒæä¾›ã•ã‚Œãªã„å ´åˆã‚„ã€æ¤œç´¢çµæœãŒä¸ç¢ºã‹ãªå ´åˆã¯ã€ãã®æ—¨ã‚’è¿°ã¹ã¦ãã ã•ã„ã€‚";

            const payload = {
                contents: [{ parts: [{ text: text }] }],
                // Google Searchã«ã‚ˆã‚‹ã‚°ãƒ©ã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const res = await fetchWithBackoff(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            
            if (!res.ok) {
                const errorMessage = data.error?.message || "APIå´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚­ãƒ¼ã®æœ‰åŠ¹æ€§ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                throw new Error(`Gemini APIã‚¨ãƒ©ãƒ¼: ${res.status} ${res.statusText}\nè©³ç´°: ${errorMessage}`);
            }

            const candidate = data.candidates?.[0];
            const resultText = candidate?.content?.parts?.[0]?.text || "å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
            output.textContent = resultText;

            // å¼•ç”¨å…ƒæƒ…å ±ã‚’æŠ½å‡ºã—ã¦è¡¨ç¤º
            const groundingMetadata = candidate?.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                const sources = groundingMetadata.groundingAttributions
                    .map((attribution, index) => {
                        const uri = attribution.web?.uri;
                        const title = attribution.web?.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—';
                        if (uri) {
                            return `<div class="source-item">
                                        <span class="font-semibold text-indigo-600">(${index + 1})</span> 
                                        <a href="${uri}" target="_blank" class="text-gray-700 hover:text-indigo-600 hover:underline">${title}</a>
                                    </div>`;
                        }
                        return null;
                    })
                    .filter(item => item !== null)
                    .join('');
                
                if (sources) {
                    sourcesDiv.innerHTML += sources;
                    sourcesDiv.classList.remove("hidden");
                }
            }

        } catch (e) {
            output.textContent = "âŒ ã‚¨ãƒ©ãƒ¼: " + e.message;
            showModal("ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å‡¦ç†ã‚¨ãƒ©ãƒ¼", e.message, 'text-red-600');
        } finally {
            setLoading(factCheckBtn, checkText, checkLoading, false, 'ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ');
        }
    }

    // --- Hugging Face ç”»åƒç”Ÿæˆ (å‰å›ã‹ã‚‰ã®å¤‰æ›´ãªã—) ---
    async function runHF() {
      const key = hfKeyInput.value.trim();
      const prompt = promptInput.value.trim();
      output.textContent = "";
      sourcesDiv.classList.add("hidden");
      imageResult.classList.add("hidden");

      if (!key) return showModal("ã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼", "Hugging Face APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", 'text-red-600');
      if (!prompt) return showModal("å…¥åŠ›ã‚¨ãƒ©ãƒ¼", "ç”Ÿæˆã—ãŸã„ç”»åƒã®èª¬æ˜ (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ) ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", 'text-yellow-600');
      
      setLoading(imgBtn, imgText, imgLoading, true, 'ç”»åƒç”Ÿæˆ (Hugging Face)');
      output.textContent = "ğŸ”„ ç”»åƒç”Ÿæˆä¸­... (æ•°ç§’ã€œæ•°åç§’ã‹ã‹ã‚Šã¾ã™)";

      try {
        const res = await fetchWithBackoff(`https://api-inference.huggingface.co/models/${HF_MODEL}`, {
          method: "POST",
          headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
          body: JSON.stringify({ inputs: prompt })
        });
        
        if (!res.ok) {
            let errorDetail = "ä¸æ˜ãªAPIã‚¨ãƒ©ãƒ¼";
            try {
                const errorData = await res.json();
                errorDetail = errorData.error || JSON.stringify(errorData);
            } catch (e) {
                errorDetail = await res.text();
            }
            throw new Error(`Hugging Face APIã‚¨ãƒ©ãƒ¼: ${res.status} ${res.statusText}\nè©³ç´°: ${errorDetail}`);
        }
        
        const blob = await res.blob();
        if (blob.type.includes('image')) {
            const objectURL = URL.createObjectURL(blob);
            imageResult.src = objectURL;
            imageResult.classList.remove("hidden");
            output.textContent = `âœ… ç”»åƒç”Ÿæˆã«æˆåŠŸã—ã¾ã—ãŸï¼ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: "${prompt}"`;
        } else {
            const textResponse = await blob.text();
            throw new Error("å¿œç­”å½¢å¼ãŒç”»åƒã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ¢ãƒ‡ãƒ«ãŒã¾ã ãƒ­ãƒ¼ãƒ‰ä¸­ã‹ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«å¼•ã£ã‹ã‹ã£ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\nè©³ç´°: " + textResponse);
        }

      } catch (err) {
        output.textContent = "âŒ ã‚¨ãƒ©ãƒ¼: " + err.message;
        showModal("ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼", err.message, 'text-red-600');
      } finally {
        setLoading(imgBtn, imgText, imgLoading, false, 'ç”»åƒç”Ÿæˆ (Hugging Face)');
      }
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    document.getElementById('factCheckBtn').addEventListener('click', runFactChecker);
    document.getElementById('imgBtn').addEventListener('click', runHF);
  </script>
</body>
</html>

