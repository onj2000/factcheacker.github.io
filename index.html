<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIメディア判別システム</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
    }
    .card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
    }
    textarea { resize: vertical; }
    .loading-spinner {
      border-top-color: #ffffff;
      -webkit-animation: spinner 1s linear infinite;
      animation: spinner 1s linear infinite;
    }
    @keyframes spinner {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="p-4">
  <main class="max-w-3xl mx-auto space-y-8">
    <h1 class="text-3xl font-extrabold text-gray-900 text-center">🧠 AIメディア判別・生成システム</h1>
    
    <!-- 1. テキスト解析 (Gemini) セクション -->
    <div class="card space-y-4 border-t-4 border-blue-500">
        <h2 class="text-xl font-bold text-blue-600">テキスト解析 (AI判別)</h2>
        <input id="geminiKey" type="password" placeholder="Google Gemini APIキーを入力 (必須)" 
               class="w-full border border-gray-300 p-3 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
        
        <!-- 料金・API取得方法に関する説明 -->
        <div class="text-xs p-3 bg-blue-50 border border-blue-200 rounded-lg text-gray-700">
            <p class="font-semibold text-blue-700">💡 Gemini APIの利用に関する注意事項</p>
            <ul class="list-disc list-inside ml-2 space-y-1 mt-1">
                <li>本システムは**Gemini APIの無料枠**を利用しますが、**リクエスト数超過**や**有料プランへの登録**により**課金が発生する可能性**があります。</li>
                <li>APIキーは、<a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a>で取得し、ご自身の責任で管理してください。</li>
            </ul>
        </div>
        
        <textarea id="inputText" rows="4" placeholder="解析したいテキストを入力..." 
                  class="w-full border border-gray-300 p-3 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"></textarea>
        
        <button id="analyzeBtn" class="analyze-btn w-full bg-blue-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center disabled:opacity-50">
            <span id="analyzeText">解析開始 (Gemini)</span>
            <div id="analyzeLoading" class="hidden w-5 h-5 border-2 border-solid rounded-full loading-spinner border-r-transparent ml-2"></div>
        </button>

        <p class="text-sm font-semibold text-gray-700 mt-4">解析結果:</p>
        <pre id="output" class="whitespace-pre-wrap bg-gray-50 border border-gray-200 p-4 rounded-lg h-64 overflow-auto text-sm text-gray-800"></pre>
    </div>

    <!-- 2. 画像生成 (Hugging Face) セクション -->
    <div class="card space-y-4 border-t-4 border-green-500">
        <h2 class="text-xl font-bold text-green-600">画像生成 (Stable Diffusion)</h2>
        <input id="hfKey" type="password" placeholder="Hugging Face APIキーを入力 (必須)" 
               class="w-full border border-gray-300 p-3 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm">

        <!-- API取得方法に関する説明 -->
        <div class="text-xs p-3 bg-green-50 border border-green-200 rounded-lg text-gray-700">
            <p class="font-semibold text-green-700">💡 Hugging Face APIキーについて</p>
            <ul class="list-disc list-inside ml-2 space-y-1 mt-1">
                <li>Hugging FaceのAPIキー（アクセストークン）は、<a href="https://huggingface.co/settings/tokens" target="_blank" class="text-green-600 hover:underline">Settings &gt; Access Tokens</a>から取得できます。</li>
                <li>無料モデルを利用していますが、高頻度の利用や安定性を求める場合は有料プランが必要です。</li>
            </ul>
        </div>
        
        <input id="prompt" placeholder="生成したい画像の説明を入力 (例: 宇宙を旅する猫)" 
               class="w-full border border-gray-300 p-3 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm">
        
        <button id="imgBtn" class="generate-btn w-full bg-green-600 text-white font-semibold py-3 rounded-xl shadow-lg hover:bg-green-700 transition duration-150 flex items-center justify-center disabled:opacity-50">
            <span id="imgText">画像生成 (Hugging Face)</span>
            <div id="imgLoading" class="hidden w-5 h-5 border-2 border-solid rounded-full loading-spinner border-r-transparent ml-2"></div>
        </button>
        <p class="text-xs text-yellow-600 bg-yellow-50 p-2 rounded-lg border border-yellow-200">
            ⚠️ Hugging Faceの無料モデルは応答に時間がかかるか、失敗する場合があります。
        </p>

        <img id="imageResult" alt="生成された画像" class="mt-4 rounded-lg shadow-xl w-full hidden border border-gray-300">
    </div>
  </main>
  
  <!-- カスタムモーダル (alertの代替) -->
  <div id="customModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-50">
    <div class="relative p-6 bg-white w-96 rounded-xl shadow-2xl transform transition-all scale-100">
        <h3 id="modalTitle" class="text-xl font-bold text-red-600 border-b pb-2 mb-3">エラーが発生しました</h3>
        <p id="modalMessage" class="text-gray-700 whitespace-pre-wrap"></p>
        <button onclick="document.getElementById('customModal').classList.add('hidden')" 
                class="mt-6 w-full py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition shadow-md">閉じる</button>
    </div>
  </div>

  <script>
    // --- 定数とDOM要素 ---
    // モデルを更新
    const MODEL_GEMINI = "gemini-2.5-flash-preview-09-2025";
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/" + MODEL_GEMINI + ":generateContent?key=";
    const HF_MODEL = "stabilityai/stable-diffusion-2"; // 例として無料利用可能なモデルを選択

    const geminiKeyInput = document.getElementById('geminiKey');
    const hfKeyInput = document.getElementById('hfKey');
    const inputText = document.getElementById('inputText');
    const promptInput = document.getElementById('prompt');
    const output = document.getElementById('output');
    const imageResult = document.getElementById('imageResult');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const imgBtn = document.getElementById('imgBtn');
    const analyzeText = document.getElementById('analyzeText');
    const imgText = document.getElementById('imgText');
    const analyzeLoading = document.getElementById('analyzeLoading');
    const imgLoading = document.getElementById('imgLoading');

    /**
     * カスタムモーダルを表示する関数 (alertの代替)
     */
    function showModal(title, message, colorClass = 'text-red-600') {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalTitle').className = `text-xl font-bold border-b pb-2 mb-3 ${colorClass}`;
        document.getElementById('modalMessage').textContent = message;
        modal.classList.remove('hidden');
    }
    
    /**
     * ボタンのローディング状態を切り替える
     */
    function setLoading(btn, textSpan, loadingIndicator, isLoading, originalText) {
        btn.disabled = isLoading;
        if (isLoading) {
            textSpan.textContent = "処理中...";
            loadingIndicator.classList.remove('hidden');
            btn.classList.add('bg-gray-500', 'hover:bg-gray-500');
            // 元のホバークラスを削除 (元のボタンの色に応じて調整)
            btn.classList.remove('hover:bg-blue-700', 'hover:bg-green-700');
        } else {
            textSpan.textContent = originalText;
            loadingIndicator.classList.add('hidden');
            btn.classList.remove('bg-gray-500', 'hover:bg-gray-500');
            // 元のホバークラスを再追加
            if (btn.id === 'analyzeBtn') {
                btn.classList.add('hover:bg-blue-700');
            } else {
                btn.classList.add('hover:bg-green-700');
            }
        }
    }

    /**
     * API呼び出しと指数バックオフ処理
     */
    async function fetchWithBackoff(url, options) {
        const MAX_RETRIES = 3;
        for (let i = 0; i < MAX_RETRIES; i++) {
            try {
                const response = await fetch(url, options);
                return response;
            } catch (error) {
                if (i === MAX_RETRIES - 1) throw new Error("ネットワーク接続エラー: " + error.message);
                const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }


    // --- Gemini API 呼び出し (テキスト解析) ---
    async function runGemini() {
      const key = geminiKeyInput.value.trim();
      const text = inputText.value.trim();
      imageResult.classList.add("hidden");
      output.textContent = "";

      if (!key) return showModal("キーエラー", "Google Gemini APIキーを入力してください。", 'text-red-600');
      if (!text) return showModal("入力エラー", "解析したいテキストを入力してください。", 'text-yellow-600');
      
      setLoading(analyzeBtn, analyzeText, analyzeLoading, true, '解析開始 (Gemini)');
      output.textContent = "🔄 解析中... (Gemini)";

      try {
        const url = GEMINI_API_URL + key;
        const prompt = `あなたはAI生成された文章かどうかを判別するAIエージェントです。以下のテキストを分析し、それがAIによって生成されたものである確率をパーセンテージで示し、その理由を詳細に記述してください。回答は日本語で行ってください。\n\n【テキスト】\n${text}`;

        const res = await fetchWithBackoff(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }]
          })
        });

        const data = await res.json();
        
        if (!res.ok) {
            const errorMessage = data.error?.message || "API側でエラーが発生しました。キーの有効性を確認してください。";
            throw new Error(`Gemini APIエラー: ${res.status} ${res.statusText}\n詳細: ${errorMessage}`);
        }

        output.textContent = data.candidates?.[0]?.content?.parts?.[0]?.text || "応答テキストが見つかりませんでした。";

      } catch (e) {
        output.textContent = "❌ エラー: " + e.message;
        showModal("Gemini処理エラー", e.message, 'text-red-600');
      } finally {
        setLoading(analyzeBtn, analyzeText, analyzeLoading, false, '解析開始 (Gemini)');
      }
    }

    // --- Hugging Face 画像生成 ---
    async function runHF() {
      const key = hfKeyInput.value.trim();
      const prompt = promptInput.value.trim();
      output.textContent = "";
      imageResult.classList.add("hidden");

      if (!key) return showModal("キーエラー", "Hugging Face APIキーを入力してください。", 'text-red-600');
      if (!prompt) return showModal("入力エラー", "生成したい画像の説明 (プロンプト) を入力してください。", 'text-yellow-600');
      
      setLoading(imgBtn, imgText, imgLoading, true, '画像生成 (Hugging Face)');
      output.textContent = "🔄 画像生成中... (数秒〜数十秒かかります)";

      try {
        const res = await fetchWithBackoff(`https://api-inference.huggingface.co/models/${HF_MODEL}`, {
          method: "POST",
          headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
          body: JSON.stringify({ inputs: prompt })
        });
        
        if (!res.ok) {
            let errorDetail = "不明なAPIエラー";
            try {
                const errorData = await res.json();
                errorDetail = errorData.error || JSON.stringify(errorData);
            } catch (e) {
                errorDetail = await res.text();
            }
            throw new Error(`Hugging Face APIエラー: ${res.status} ${res.statusText}\n詳細: ${errorDetail}`);
        }
        
        const blob = await res.blob();
        if (blob.type.includes('image')) {
            const objectURL = URL.createObjectURL(blob);
            imageResult.src = objectURL;
            imageResult.classList.remove("hidden");
            output.textContent = `✅ 画像生成に成功しました！ プロンプト: "${prompt}"`;
        } else {
            const textResponse = await blob.text();
            throw new Error("応答形式が画像ではありません。モデルがまだロード中か、レート制限に引っかかった可能性があります。\n詳細: " + textResponse);
        }

      } catch (err) {
        output.textContent = "❌ エラー: " + err.message;
        showModal("画像生成エラー", err.message, 'text-red-600');
      } finally {
        setLoading(imgBtn, imgText, imgLoading, false, '画像生成 (Hugging Face)');
      }
    }

    // --- イベントリスナー ---
    document.getElementById('analyzeBtn').addEventListener('click', runGemini);
    document.getElementById('imgBtn').addEventListener('click', runHF);
  </script>
</body>
</html>

