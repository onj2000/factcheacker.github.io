<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SNSã‚³ãƒ¡ãƒ³ãƒˆãƒªã‚¹ã‚¯åˆ†æãƒ„ãƒ¼ãƒ«</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã¨å…¨ä½“ã®èƒŒæ™¯ */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap');
    body {
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      background-color: #f7f9fb;
    }
    .container-box { box-shadow: 0 10px 30px rgba(0,0,0,0.08); }

    /* --- ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ³ã‚¯ã‚¹ã‚¿ã‚¤ãƒ« (é’ã„ä¸‹ç·šä»˜ã) --- */
    .custom-link {
      color: #1e40af; /* blue-700 */
      text-decoration: none;
      font-weight: 500;
      padding-bottom: 2px;
      position: relative;
      transition: color 0.3s ease;
      display: inline-block;
    }
    .custom-link::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 2px;
      background-color: #3b82f6; /* blue-500 */
      transition: height 0.3s ease, background-color 0.3s ease;
    }
    .custom-link:hover { color: #1d4ed8; }
    .custom-link:hover::after {
      height: 4px;
      background-color: #1e40af;
    }
    /* --- åˆ†é¡ã‚¿ã‚°ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .classification-tag {
      padding: 4px 12px;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 0.875rem;
      display: inline-block;
      min-width: 100px;
      text-align: center;
    }
    .color-safe { background-color: #dcfce7; color: #166534; }
    .color-slander { background-color: #fef9c3; color: #854d0e; }
    .color-false { background-color: #ffedd5; color: #9a3412; }
    .color-crime { background-color: #fee2e2; color: #991b1b; }
    .color-bot { background-color: #f3e8ff; color: #6b21a8; }
    .color-unknown { background-color: #e5e7eb; color: #4b5563; }

    /* ãƒ­ãƒ¼ãƒ€ãƒ¼ */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 24px; height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
  <div class="max-w-4xl mx-auto w-full">

    <header class="mb-8 text-center">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">SNSã‚³ãƒ¡ãƒ³ãƒˆ ãƒªã‚¹ã‚¯åˆ†æãƒ„ãƒ¼ãƒ«</h1>
      <p class="text-gray-600">AIã‚’ä½¿ã„ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’å±é™ºåº¦åˆ¥ã«åˆ†é¡ã—ã€è«–èª¿ï¼ˆæ„Ÿæƒ…çš„/è«–ç†çš„ï¼‰ã‚’åˆ†æã—ã¾ã™ã€‚</p>
    </header>

    <!-- APIã‚­ãƒ¼ã¨ã‚³ã‚¹ãƒˆã®èª¬æ˜ -->
    <details class="bg-red-50 border border-red-300 p-6 rounded-xl mb-8 container-box">
      <summary class="text-lg font-bold text-red-800 cursor-pointer">âš ï¸ APIã‚­ãƒ¼ã®å–å¾—ã€ã‚³ã‚¹ãƒˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦</summary>
      <div class="mt-4 space-y-4 text-gray-700 border-t border-red-300 pt-4">
        
        <h3 class="text-xl font-semibold text-green-700">âœ… ç„¡æ–™åˆ©ç”¨æ ã«ã¤ã„ã¦ (é‡è¦)</h3>
        <ul class="list-disc ml-4 space-y-2">
            <li>**AIãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ :** ã»ã¨ã‚“ã©ã®AIãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ã¯ã€**æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®ç„¡æ–™åˆ©ç”¨æ **ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãšã¯ç„¡æ–™ã§ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã§ãã¾ã™ã€‚</li>
            <li>ãŸã ã—ã€ç„¡æ–™æ ã‚’è¶…ãˆã‚‹ã¨**è‡ªå‹•çš„ã«å¾“é‡èª²é‡‘**ã«ç§»è¡Œã—ã¾ã™ã€‚å¿…ãšæ¬¡ã®ã€Œã‚³ã‚¹ãƒˆã¨èª²é‡‘ã€ã®é …ç›®ã‚’ç¢ºèªã—ã€åˆ©ç”¨åˆ¶é™ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</li>
        </ul>

        <h3 class="text-xl font-semibold text-red-800 pt-4">ğŸš¨ ã‚³ã‚¹ãƒˆã¨èª²é‡‘ã«é–¢ã™ã‚‹é‡è¦äº‹é …</h3>
        <ul class="list-disc ml-4 space-y-2">
            <li>**å¾“é‡èª²é‡‘åˆ¶:** Google Gemini APIã€OpenAI APIã¯ã™ã¹ã¦å¾“é‡èª²é‡‘åˆ¶ã§ã™ã€‚åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ãŸã³ã«ã€ã‚³ãƒ¡ãƒ³ãƒˆã®æ–‡å­—æ•°ã«å¿œã˜ã¦è²»ç”¨ãŒç™ºç”Ÿã—ã¾ã™ã€‚</li>
            <li>**åˆ©ç”¨åˆ¶é™ã®è¨­å®š:** äºˆæœŸã›ã¬é«˜é¡è«‹æ±‚ã‚’é˜²ããŸã‚ã€**å¿…ãšå„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆGoogle Cloudã¾ãŸã¯OpenAI Platformï¼‰ã§åˆ©ç”¨åˆ¶é™ï¼ˆBilling Limitï¼‰ã‚’è¨­å®š**ã—ã¦ãã ã•ã„ã€‚</li>
            <li>**ã‚³ã‚¹ãƒˆåŠ¹ç‡ã®é¸æŠè‚¢:** **Gemini 2.5 Flash-Lite**ã¨**GPT-4o mini**ãŒã€ç¾åœ¨æœ€ã‚‚ä½ã‚³ã‚¹ãƒˆã§åˆ©ç”¨ã§ãã‚‹é«˜æ€§èƒ½ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚</li>
        </ul>

        <h3 class="text-xl font-semibold text-gray-800 pt-4">ğŸŒ Google Gemini (æ¨å¥¨)</h3>
        <p class="text-sm">Geminiãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ã€**Webå‚ç…§æ©Ÿèƒ½**ã«ã‚ˆã‚Šæœ€æ–°æƒ…å ±ã‚’å‚ç…§ã—ã¦åˆ†æã§ãã¾ã™ãŒã€**æ§‹é€ åŒ–å‡ºåŠ›ã¨ã®ä¸¡ç«‹ã®ãŸã‚ã€æ­£å¼ãªæƒ…å ±æºã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“**ã€‚</p>
        <ul class="list-disc ml-4">
          <li>ã‚­ãƒ¼ç™ºè¡Œ: <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" class="custom-link">Google AI Studio (APIã‚­ãƒ¼ãƒšãƒ¼ã‚¸)</a></li>
          <li>æ–™é‡‘è©³ç´°: <a href="https://ai.google.dev/pricing" target="_blank" class="custom-link">Google AI ä¾¡æ ¼ãƒšãƒ¼ã‚¸</a></li>
        </ul>

        <h3 class="text-xl font-semibold text-gray-800 pt-4">ğŸ’» GPT (OpenAI)</h3>
        <ul class="list-disc ml-4">
          <li>ã‚­ãƒ¼ç™ºè¡Œ: <a href="https://platform.openai.com/account/api-keys" target="_blank" class="custom-link">OpenAI Platform (APIã‚­ãƒ¼ãƒšãƒ¼ã‚¸)</a></li>
          <li>æ–™é‡‘è©³ç´°: <a href="https://openai.com/pricing" target="_blank" class="custom-link">OpenAI ä¾¡æ ¼ãƒšãƒ¼ã‚¸</a></li>
        </ul>
        
        <h3 class="text-xl font-semibold text-red-800 pt-4">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ³¨æ„</h3>
        <p class="text-sm font-bold">ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§APIã‚­ãƒ¼ã‚’ç›´æ¥ä½¿ç”¨ã—ã¾ã™ã€‚ã‚­ãƒ¼ã®ç®¡ç†ã«ã¯ååˆ†æ³¨æ„ã—ã€åˆ†æãŒçµ‚äº†ã—ãŸã‚‰ã™ãã«ã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚</p>
      </div>
    </details>

    <!-- è¨­å®šã¨å…¥åŠ› -->
    <div class="bg-white p-6 sm:p-8 rounded-xl container-box mb-8">
      <h2 class="text-xl font-bold text-gray-800 mb-4">åˆ†æè¨­å®šã¨å…¥åŠ›</h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
          <div>
            <label for="model-select" class="block text-sm font-semibold text-gray-700 mb-2">AIãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ</label>
            <select id="model-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
              <option value="gemini-flash">Google Gemini 2.5 Flash (é«˜æ€§èƒ½)</option>
              <option value="gemini-lite" selected>Google Gemini 2.5 Flash-Lite (æœ€å®‰ä¾¡)</option>
              <option value="openai">OpenAI GPT-4o mini (æœ€å®‰ä¾¡)</option>
            </select>
          </div>
          <div>
            <label id="key-label" for="api-key-input" class="block text-sm font-semibold text-gray-700 mb-2">APIã‚­ãƒ¼</label>
            <input id="api-key-input" type="password" placeholder="AIzã§å§‹ã¾ã‚‹ã‚­ãƒ¼ã‚’å…¥åŠ›" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
          </div>
      </div>

      <label class="block text-lg font-semibold text-gray-700 mb-3 mt-4">åˆ†æã—ãŸã„SNSã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
      <textarea id="comment-input" rows="4" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ä¾‹: ã‚ã®ä¼šç¤¾ã¯æ˜æ—¥å€’ç”£ã™ã‚‹ã€‚ã“ã‚Œã¯å†…éƒ¨æƒ…å ±ã ã€‚"></textarea>

      <button id="analyze-button" onclick="analyzeComment()" class="mt-4 w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
        <div id="button-text">ã‚³ãƒ¡ãƒ³ãƒˆã‚’åˆ†æã™ã‚‹</div>
        <div id="loading-spinner" class="hidden loader ml-2"></div>
      </button>
    </div>

    <!-- çµæœ -->
    <div id="results-area" class="hidden bg-white p-6 sm:p-8 rounded-xl container-box">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">åˆ†æçµæœ</h2>
      
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
        <div class="flex items-center">
          <span class="text-gray-600 font-medium mr-4 text-lg">åˆ†é¡:</span>
          <span id="classification-display" class="classification-tag"></span>
        </div>
        <div class="flex items-center">
          <span class="text-gray-600 font-medium mr-4 text-lg">è«–èª¿:</span>
          <span id="argument-type-display" class="font-bold text-lg text-gray-900 bg-gray-100 p-2 rounded-lg text-center w-full"></span>
        </div>
      </div>
      
      <div class="mb-6">
        <h3 class="text-xl font-semibold text-gray-700 mb-2">æ ¹æ‹ ãƒ»åˆ†æ</h3>
        <div id="reasoning-display" class="text-gray-800 p-4 bg-gray-50 rounded-lg border border-gray-200 whitespace-pre-wrap"></div>
      </div>
      
      <!-- æƒ…å ±æºã‚¨ãƒªã‚¢ (æ§‹é€ åŒ–å‡ºåŠ›å„ªå…ˆã®ãŸã‚ã€ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã¯éä½¿ç”¨) -->
      <div id="sources-container" class="hidden mt-4 pt-4 border-t border-gray-200">
        <h3 class="text-xl font-semibold text-gray-700 mb-2 flex items-center">
            <svg class="w-5 h-5 mr-1 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.27a1 1 0 01.112.181l.088.22a1 1 0 01.037.289v9.544a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h7.828a1 1 0 01.707.293l3.586 3.586a1 1 0 01.293.707V7z"></path></svg>
            æƒ…å ±æº
        </h3>
        <ul id="sources-list" class="space-y-2 text-sm ml-2"></ul>
        <p class="text-xs text-gray-500 mt-2">â€» ç¾åœ¨ã€JSONæ§‹é€ åŒ–å‡ºåŠ›ã¨ã®ä¸¡ç«‹ã®ãŸã‚ã€æ­£å¼ãªæƒ…å ±æºã®è¡¨ç¤ºã¯ã§ãã¾ã›ã‚“ã€‚</p>
      </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ -->
    <div id="error-message" class="hidden mt-8 p-4 bg-red-100 text-red-700 border border-red-200 rounded-lg container-box">
      <span class="font-bold">ã‚¨ãƒ©ãƒ¼: </span>
      <span id="error-text"></span>
    </div>

  </div>

<script>
const MODEL_CONFIG = {
  "gemini-flash": {
    endpoint: "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent",
    modelName: "gemini-2.5-flash-preview-09-2025",
    type: "gemini"
  },
  "gemini-lite": {
    endpoint: "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite-preview:generateContent", // Flash-Liteã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    modelName: "gemini-2.5-flash-lite-preview",
    type: "gemini"
  },
  "openai": {
    endpoint: "https://api.openai.com/v1/chat/completions",
    modelName: "gpt-4o-mini", // GPTã®å®‰ä¾¡ãƒ¢ãƒ‡ãƒ«
    type: "openai"
  }
};

const CLASSIFICATION_MAP = {
    "çŠ¯ç½ªåŠ©é•·": { color: "color-crime", display: "çŠ¯ç½ªè¡Œç‚º/è„…è¿«" },
    "èª¹è¬—ä¸­å‚·": { color: "color-slander", display: "èª¹è¬—ä¸­å‚·/ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ" },
    "è™šå½æƒ…å ±": { color: "color-false", display: "ãƒ•ã‚§ã‚¤ã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹/èª¤æƒ…å ±" },
    "è‡ªå‹•æŠ•ç¨¿ï¼ˆbotï¼‰": { color: "color-bot", display: "Bot/è‡ªå‹•ç”Ÿæˆ" },
    "å®‰å…¨": { color: "color-safe", display: "å®‰å…¨/å•é¡Œãªã—" },
    "ä¸æ˜": { color: "color-unknown", display: "ä¸æ˜/è§£æä¸èƒ½" }
};

// --- DOMè¦ç´  ---
const modelSelect = document.getElementById('model-select');
const apiKeyInput = document.getElementById('api-key-input');
const commentInput = document.getElementById('comment-input');
const analyzeButton = document.getElementById('analyze-button');
const buttonText = document.getElementById('button-text');
const loadingSpinner = document.getElementById('loading-spinner');
const resultsArea = document.getElementById('results-area');
const classificationDisplay = document.getElementById('classification-display');
const argumentTypeDisplay = document.getElementById('argument-type-display'); 
const reasoningDisplay = document.getElementById('reasoning-display');
const sourcesContainer = document.getElementById('sources-container');
const sourcesList = document.getElementById('sources-list');
const errorMessage = document.getElementById('error-message');
const errorText = document.getElementById('error-text');
const keyLabel = document.getElementById('key-label');

// --- åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
modelSelect.addEventListener('change', updateAPIKeyPrompt);
document.addEventListener('DOMContentLoaded', updateAPIKeyPrompt);

/**
 * ãƒ¢ãƒ‡ãƒ«é¸æŠæ™‚ã®UIè¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
 */
function updateAPIKeyPrompt() {
    const modelKey = modelSelect.value;
    const config = MODEL_CONFIG[modelKey];
    const isGemini = config.type === 'gemini';
    const isCanvasAutoFilled = isGemini && typeof __initial_auth_token !== 'undefined';

    if (isGemini) {
        keyLabel.textContent = "Google Gemini APIã‚­ãƒ¼";
        apiKeyInput.placeholder = isCanvasAutoFilled ? "ã‚­ãƒ¼ã‚’å…¥åŠ›ï¼ˆç©ºæ¬„ã§è‡ªå‹•èªè¨¼ã‚’è©¦è¡Œï¼‰" : "AIzã§å§‹ã¾ã‚‹ã‚­ãƒ¼ã‚’å…¥åŠ›";
    } else {
        keyLabel.textContent = "OpenAI APIã‚­ãƒ¼";
        apiKeyInput.placeholder = "sk-ã§å§‹ã¾ã‚‹ã‚­ãƒ¼ã‚’å…¥åŠ›";
    }

    if (apiKeyInput.value === 'CANVAS_AUTO_FILLED') {
        apiKeyInput.value = '';
    }
}

/**
 * APIã‚­ãƒ¼ã®å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 */
function validateApiKey(modelType, key) {
    if (modelType === 'gemini') {
        // Canvasç’°å¢ƒã®è‡ªå‹•èªè¨¼ã«ä¾å­˜ã™ã‚‹å ´åˆã¯ç©ºæ¬„ã‚’è¨±å¯
        if (key === '') return { valid: true }; 
        if (!key.startsWith('AIza')) {
            return { valid: false, message: "Geminiã‚­ãƒ¼ã¯é€šå¸¸ 'AIza' ã§å§‹ã¾ã‚Šã¾ã™ã€‚ã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚" };
        }
    } else if (modelType === 'openai') {
        if (key === '') {
             return { valid: false, message: "OpenAIãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚" };
        }
        if (!key.startsWith('sk-')) {
            return { valid: false, message: "OpenAIã‚­ãƒ¼ã¯ 'sk-' ã§å§‹ã¾ã‚Šã¾ã™ã€‚ã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚" };
        }
    }
    return { valid: true };
}


/**
 * ã‚³ãƒ¡ãƒ³ãƒˆã‚’åˆ†æã—ã€çµæœã‚’UIã«è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
 */
async function analyzeComment() {
  const comment = commentInput.value.trim();
  const modelKey = modelSelect.value;
  const config = MODEL_CONFIG[modelKey];
  let apiKey = apiKeyInput.value.trim();
  
  if (!comment) return showError("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  
  const isGemini = config.type === 'gemini';

  // 1. APIã‚­ãƒ¼ã®æ¤œè¨¼
  const keyValidation = validateApiKey(config.type, apiKey);
  if (!keyValidation.valid) {
      return showError("APIã‚­ãƒ¼ã®å½¢å¼ãŒé–“é•ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™: " + keyValidation.message);
  }
  
  // 2. APIã‚­ãƒ¼ã®è¨­å®š (Geminiã®å ´åˆã€ç©ºæ¬„ãªã‚‰è‡ªå‹•èªè¨¼ã«ä¾å­˜)
  if (isGemini && apiKey === '') {
      console.log("Relying on Canvas environment for Gemini API Key.");
  } else if (!isGemini && apiKey === '') {
      return showError("OpenAIãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  }

  setLoading(true);
  try {
    let result = null;
    let response = null;

    if (isGemini) {
        console.log(`--- Gemini API Call (Model: ${config.modelName}) ---`);
        // APIã‚­ãƒ¼ã¯ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã€‚æ‰‹å‹•ã§å…¥åŠ›ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ç©ºæ¬„ã€‚
        const url = `${config.endpoint}?key=${apiKey}`;
        
        const body = {
            contents: [{ parts: [{ text: comment }] }],
            systemInstruction: { parts: [{ text: generateSystemPrompt(config.modelName) }] },
            // æ§‹é€ åŒ–å‡ºåŠ›
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        classification: { type: "STRING" },
                        argument_type: { type: "STRING" }, 
                        reasoning: { type: "STRING" }
                    },
                    required: ["classification", "argument_type", "reasoning"] 
                }
            },
            // Webå‚ç…§ (Flashãƒ¢ãƒ‡ãƒ«ã§ã®ã¿æœ‰åŠ¹ãªæŒ‡ç¤ºã‚’å‡ºã™)
            // tools: [{ "google_search": {} }],
        };
        
        response = await fetchWithExponentialBackoff(url, {
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify(body)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error("Gemini HTTP Error Response:", response.status, errorText);
            
            let userMessage = `Gemini APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ ${response.status}ã€‚`;
            if (response.status === 400) {
                 userMessage = `ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚**Gemini APIã‚­ãƒ¼ã€ã¾ãŸã¯å…¥åŠ›å†…å®¹ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æœ‰åŠ¹åŒ–**ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®è©³ç´°: ${errorText.substring(0, 150)}...`;
            } else if (response.status === 401 || response.status === 403) {
                userMessage += "APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã€ã¾ãŸã¯èª²é‡‘ãŒæœ‰åŠ¹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
            } else {
                 userMessage += "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ã§ã™ã€‚";
            }
            throw new Error(userMessage);
        }

        const rawData = await response.json();
        const jsonText = rawData.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (!jsonText) {
            console.error("Gemini API Error: Missing JSON content in response.", rawData);
            throw new Error(rawData.error?.message || "Geminiã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™ã€‚APIã‚­ãƒ¼ãŒæœ‰åŠ¹ã‹ã€èª²é‡‘ãŒæœ‰åŠ¹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
        
        result = JSON.parse(jsonText);

    } else { // OpenAI
        console.log(`--- OpenAI API Call (Model: ${config.modelName}) ---`);
        const body = {
            model: config.modelName,
            messages: [{ role: "system", content: generateSystemPrompt(config.modelName) }, { role: "user", content: comment }],
            response_format: { type: "json_object" }
        };
        
        response = await fetchWithExponentialBackoff(config.endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${apiKey}` },
            body: JSON.stringify(body)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error("OpenAI HTTP Error Response:", response.status, errorText);
            let userMessage = `OpenAI APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ ${response.status}ã€‚`;
            if (response.status === 401) {
                userMessage += "APIã‚­ãƒ¼ãŒæœ‰åŠ¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
            }
            throw new Error(userMessage);
        }
        
        const rawData = await response.json();
        const jsonText = rawData.choices?.[0]?.message?.content;

        if (!jsonText) {
            console.error("OpenAI API Error: Missing JSON content in response.", rawData);
            throw new Error("OpenAIã‹ã‚‰ã®çµæœè§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ãŒæœ‰åŠ¹ã‹ã€èª²é‡‘ãŒæœ‰åŠ¹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
        
        // JSONä»¥å¤–ã®æ–‡å­—åˆ—ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ã€JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡ºã—ã¦ã‹ã‚‰ãƒ‘ãƒ¼ã‚¹
        let cleanedJsonText = jsonText.trim();
        if (cleanedJsonText.startsWith("```json")) {
            cleanedJsonText = cleanedJsonText.substring(7, cleanedJsonText.lastIndexOf("```")).trim();
        } else if (cleanedJsonText.startsWith("```")) { 
             cleanedJsonText = cleanedJsonText.substring(3, cleanedJsonText.lastIndexOf("```")).trim();
        }

        result = JSON.parse(cleanedJsonText);
    }

    if (!result.classification || !result.argument_type) throw new Error("çµæœã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚classificationã¾ãŸã¯argument_typeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");

    updateResultUI(result);

  } catch (err) {
    showError("åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message + "ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    console.error("Fatal Analysis Error:", err);
  } finally {
    setLoading(false);
  }
}

/**
 * æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ããƒ•ã‚§ãƒƒãƒé–¢æ•°ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼‰
 */
async function fetchWithExponentialBackoff(url, options, maxRetries = 5) {
    for (let attempt = 0; attempt < maxRetries; attempt++) {
        try {
            const response = await fetch(url, options);
            if (response.status !== 429 && response.ok) {
                return response;
            } else if (response.status === 429) {
                // Rate limit: delay and retry
                console.warn(`Rate limit hit (429). Retrying in ${Math.pow(2, attempt)}s...`);
                const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
                await new Promise(resolve => setTimeout(resolve, delay));
            } else {
                return response; // Return non-OK response for caller to handle
            }
        } catch (error) {
            if (attempt === maxRetries - 1) {
                throw error;
            }
            // Network error: delay and retry
            console.error(`Network error on attempt ${attempt + 1}. Retrying...`, error);
            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
    throw new Error("APIå‘¼ã³å‡ºã—ãŒæœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’è¶…ãˆã¾ã—ãŸã€‚");
}

/**
 * AIãƒ¢ãƒ‡ãƒ«ã«æ¸¡ã™ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹
 */
function generateSystemPrompt(modelName) {
    const classifications = Object.keys(CLASSIFICATION_MAP).filter(c => c !== "ä¸æ˜").join('ã€ã€Œ');

    // è«–èª¿ã®åˆ¤åˆ¥ã‚’è¿½åŠ ã—ã€JSONå‡ºåŠ›æŒ‡ç¤ºã‚’å³æ ¼åŒ–
    let prompt = `ã‚ãªãŸã¯SNSã‚³ãƒ¡ãƒ³ãƒˆã‚’ä»¥ä¸‹ã®åˆ†é¡ã§è­˜åˆ¥ã—ã€ã•ã‚‰ã«**è«–èª¿ï¼ˆargument_typeï¼‰ãŒã€Œè«–ç†çš„ã€ã€ã€Œæ„Ÿæƒ…çš„ã€ã€ã¾ãŸã¯ã€Œè«–ç†çš„ï¼ˆæ„Ÿæƒ…çš„è¦ç´ ã‚ã‚Šï¼‰ã€ã®ã„ãšã‚Œã§ã‚ã‚‹ã‹**ã‚’åˆ¤å®šã™ã‚‹AIãƒªã‚¹ã‚¯ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚
    
    åˆ†æçµæœã¯ã€**å¿…ãš**JSONå½¢å¼ã§ {"classification": "åˆ†é¡å", "argument_type": "è«–èª¿", "reasoning": "åˆ†é¡ã®æ ¹æ‹ ã¨åˆ†æçµæœã‚’æ—¥æœ¬èªã§è©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"} ã®ã¿è¿”ç­”ã—ã¦ãã ã•ã„ã€‚JSONä»¥å¤–ã®æ–‡ç« ã‚„èª¬æ˜ã¯**ä¸€åˆ‡**å«ã‚ãªã„ã§ãã ã•ã„ã€‚

    åˆ†é¡: ã€Œ${classifications}ã€ã®ã„ãšã‚Œã‹ã‚’é¸æŠã™ã‚‹ã“ã¨ã€‚
    è«–èª¿: ã€Œè«–ç†çš„ã€ã€ã€Œæ„Ÿæƒ…çš„ã€ã€ã¾ãŸã¯ã€Œè«–ç†çš„ï¼ˆæ„Ÿæƒ…çš„è¦ç´ ã‚ã‚Šï¼‰ã€ã®ã„ãšã‚Œã‹ã‚’é¸æŠã™ã‚‹ã“ã¨ã€‚`;

    if (modelName === 'gemini-2.5-flash-preview-09-2025') {
        prompt += `
        åˆ†æã‚’è¡Œã†éš›ã€ã‚³ãƒ¡ãƒ³ãƒˆå†…ã®äº‹å®Ÿï¼ˆç‰¹ã«è™šå½æƒ…å ±ã‚„ãƒ•ã‚§ã‚¤ã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®å¯èƒ½æ€§ï¼‰ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã€æœ€æ–°ã®çŸ¥è­˜ã‚„Webæƒ…å ±ã‚’å‚ç…§ã—ã€åˆ†æçµæœï¼ˆreasoningï¼‰ã«åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚`;
    }
    // Flash-Liteã¨GPT-4o miniã«ã¯ã€Webå‚ç…§ã‚’æŒ‡ç¤ºã—ã¾ã›ã‚“ã€‚

    return prompt;
}

/**
 * åˆ†æçµæœã«åŸºã¥ã„ã¦UIã‚’æ›´æ–°ã™ã‚‹
 * @param {object} result - åˆ†æçµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function updateResultUI(result) {
    const classification = result.classification || "ä¸æ˜";
    const argumentType = result.argument_type || "ä¸æ˜"; 
    const reasoning = result.reasoning || "ç†ç”±ãŒæä¾›ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚";
    const mapping = CLASSIFICATION_MAP[classification] || CLASSIFICATION_MAP["ä¸æ˜"];
    
    // 1. åˆ†é¡ã‚¿ã‚°ã®æ›´æ–°
    classificationDisplay.className = "classification-tag";
    classificationDisplay.classList.add(mapping.color);
    classificationDisplay.textContent = mapping.display;
    
    // 2. è«–èª¿ã®æ›´æ–°
    argumentTypeDisplay.textContent = argumentType;
    
    // 3. æ ¹æ‹ ã®æ›´æ–°
    reasoningDisplay.textContent = reasoning;
    
    // 4. æƒ…å ±æºã®æ›´æ–° (JSONæ§‹é€ åŒ–å‡ºåŠ›ã‚’å„ªå…ˆã™ã‚‹ãŸã‚ã€ã“ã®æ©Ÿèƒ½ã¯éè¡¨ç¤º)
    sourcesContainer.classList.add('hidden');
    sourcesList.innerHTML = '';
    
    // 5. çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
    resultsArea.classList.remove("hidden");
    errorMessage.classList.add("hidden");
}

/**
 * ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
 */
function showError(msg){ 
    errorText.innerHTML = msg; 
    errorMessage.classList.remove("hidden"); 
    resultsArea.classList.add("hidden");
}

/**
 * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
 */
function setLoading(b){ 
    analyzeButton.disabled = b; 
    loadingSpinner.classList.toggle("hidden",!b); 
    buttonText.textContent = b ? "åˆ†æä¸­..." : "ã‚³ãƒ¡ãƒ³ãƒˆã‚’åˆ†æã™ã‚‹"; 
}
</script>
</body>
</html>

