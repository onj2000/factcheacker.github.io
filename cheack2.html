<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SNSã‚³ãƒ¡ãƒ³ãƒˆãƒªã‚¹ã‚¯åˆ†æãƒ„ãƒ¼ãƒ«</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã¨å…¨ä½“ã®èƒŒæ™¯ */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap');
    body {
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      background-color: #f7f9fb;
    }
    .container-box { box-shadow: 0 10px 30px rgba(0,0,0,0.08); }

    /* --- ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ³ã‚¯ã‚¹ã‚¿ã‚¤ãƒ« (é’ã„ä¸‹ç·šä»˜ã) --- */
    .custom-link {
      color: #1e40af; /* blue-700 */
      text-decoration: none;
      font-weight: 500;
      padding-bottom: 2px;
      position: relative;
      transition: color 0.3s ease;
      display: inline-block;
    }
    .custom-link::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 2px;
      background-color: #3b82f6; /* blue-500 */
      transition: height 0.3s ease, background-color 0.3s ease;
    }
    .custom-link:hover { color: #1d4ed8; }
    .custom-link:hover::after {
      height: 4px;
      background-color: #1e40af;
    }
    /* --- åˆ†é¡ã‚¿ã‚°ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .classification-tag {
      padding: 4px 12px;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 0.875rem;
      display: inline-block;
      min-width: 100px;
      text-align: center;
    }
    .color-safe { background-color: #dcfce7; color: #166534; }
    .color-slander { background-color: #fef9c3; color: #854d0e; }
    .color-false { background-color: #ffedd5; color: #9a3412; }
    .color-crime { background-color: #fee2e2; color: #991b1b; }
    .color-bot { background-color: #f3e8ff; color: #6b21a8; }

    /* ãƒ­ãƒ¼ãƒ€ãƒ¼ */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 24px; height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
  <div class="max-w-4xl mx-auto w-full">

    <header class="mb-8 text-center">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">SNSã‚³ãƒ¡ãƒ³ãƒˆ ãƒªã‚¹ã‚¯åˆ†æãƒ„ãƒ¼ãƒ«</h1>
      <p class="text-gray-600">AIï¼ˆGemini/GPTï¼‰ã‚’ä½¿ã„ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’å±é™ºåº¦åˆ¥ã«åˆ†é¡ã—ã€äº‹å®Ÿç¢ºèªï¼ˆãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ï¼‰ã‚’è¡Œã„ã¾ã™ã€‚</p>
    </header>

    <!-- APIã‚­ãƒ¼ã¨ã‚³ã‚¹ãƒˆã®èª¬æ˜ (æ›´æ–°ç®‡æ‰€) -->
    <details class="bg-red-50 border border-red-300 p-6 rounded-xl mb-8 container-box">
      <summary class="text-lg font-bold text-red-800 cursor-pointer">âš ï¸ APIã‚­ãƒ¼ã®å–å¾—ã€ã‚³ã‚¹ãƒˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦</summary>
      <div class="mt-4 space-y-4 text-gray-700 border-t border-red-300 pt-4">
        
        <h3 class="text-xl font-semibold text-green-700">âœ… ç„¡æ–™åˆ©ç”¨æ ã«ã¤ã„ã¦ (é‡è¦)</h3>
        <ul class="list-disc ml-4 space-y-2">
            <li>**Gemini / GPT:** ã»ã¨ã‚“ã©ã®AIãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ã¯ã€**æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®ç„¡æ–™åˆ©ç”¨æ **ã¾ãŸã¯ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãšã¯ç„¡æ–™ã§ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã§ãã¾ã™ã€‚</li>
            <li>ãŸã ã—ã€ç„¡æ–™æ ã®ç¯„å›²ã¯é™ã‚‰ã‚Œã¦ãŠã‚Šã€ç„¡æ–™æ ã‚’è¶…ãˆã‚‹ã¨**è‡ªå‹•çš„ã«å¾“é‡èª²é‡‘**ã«ç§»è¡Œã—ã¾ã™ã€‚å¿…ãšæ¬¡ã®ã€Œã‚³ã‚¹ãƒˆã¨èª²é‡‘ã€ã®é …ç›®ã‚’ç¢ºèªã—ã€åˆ©ç”¨åˆ¶é™ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</li>
        </ul>

        <h3 class="text-xl font-semibold text-red-800 pt-4">ğŸš¨ ã‚³ã‚¹ãƒˆã¨èª²é‡‘ã«é–¢ã™ã‚‹é‡è¦äº‹é …</h3>
        <ul class="list-disc ml-4 space-y-2">
            <li>**å¾“é‡èª²é‡‘åˆ¶:** Google Gemini APIã€OpenAI APIã¯ã™ã¹ã¦å¾“é‡èª²é‡‘åˆ¶ã§ã™ã€‚åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ãŸã³ã«ã€ã‚³ãƒ¡ãƒ³ãƒˆã®æ–‡å­—æ•°ã«å¿œã˜ã¦è²»ç”¨ãŒç™ºç”Ÿã—ã¾ã™ã€‚</li>
            <li>**åˆ©ç”¨åˆ¶é™ã®è¨­å®š:** äºˆæœŸã›ã¬é«˜é¡è«‹æ±‚ã‚’é˜²ããŸã‚ã€**å¿…ãšå„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆGoogle Cloudã¾ãŸã¯OpenAI Platformï¼‰ã§åˆ©ç”¨åˆ¶é™ï¼ˆBilling Limitï¼‰ã‚’è¨­å®š**ã—ã¦ãã ã•ã„ã€‚</li>
            <li>**ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ã®å½±éŸ¿:** Geminiã®ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã¯ã€åˆ†ææ™‚ã«Google Searchã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€å¿œç­”æ™‚é–“ãŒé•·ããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
        </ul>

        <h3 class="text-xl font-semibold text-gray-800 pt-4">ğŸŒ Gemini (æ¨å¥¨)</h3>
        <p class="text-sm">Geminiãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ã€**Google Search**ã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆæƒ…å ±æºã®æç¤ºï¼‰ãŒè‡ªå‹•ã§æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚</p>
        <ul class="list-disc ml-4">
          <li>ã‚­ãƒ¼ç™ºè¡Œ: <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" class="custom-link">Google AI Studio (APIã‚­ãƒ¼ãƒšãƒ¼ã‚¸)</a></li>
          <li>æ–™é‡‘è©³ç´°: <a href="https://ai.google.dev/pricing" target="_blank" class="custom-link">Google AI ä¾¡æ ¼ãƒšãƒ¼ã‚¸</a></li>
        </ul>

        <h3 class="text-xl font-semibold text-gray-800 pt-4">ğŸ’» GPT (OpenAI)</h3>
        <ul class="list-disc ml-4">
          <li>ã‚­ãƒ¼ç™ºè¡Œ: <a href="https://platform.openai.com/account/api-keys" target="_blank" class="custom-link">OpenAI Platform (APIã‚­ãƒ¼ãƒšãƒ¼ã‚¸)</a></li>
          <li>æ–™é‡‘è©³ç´°: <a href="https://openai.com/pricing" target="_blank" class="custom-link">OpenAI ä¾¡æ ¼ãƒšãƒ¼ã‚¸</a></li>
        </ul>
        
        <h3 class="text-xl font-semibold text-red-800 pt-4">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ³¨æ„</h3>
        <p class="text-sm font-bold">ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§APIã‚­ãƒ¼ã‚’ç›´æ¥ä½¿ç”¨ã—ã¾ã™ã€‚ã‚­ãƒ¼ã®ç®¡ç†ã«ã¯ååˆ†æ³¨æ„ã—ã€åˆ†æãŒçµ‚äº†ã—ãŸã‚‰ã™ãã«ã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚</p>
      </div>
    </details>

    <!-- è¨­å®šã¨å…¥åŠ› -->
    <div class="bg-white p-6 sm:p-8 rounded-xl container-box mb-8">
      <h2 class="text-xl font-bold text-gray-800 mb-4">åˆ†æè¨­å®šã¨å…¥åŠ›</h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
          <div>
            <label for="model-select" class="block text-sm font-semibold text-gray-700 mb-2">AIãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ</label>
            <select id="model-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
              <option value="gemini">Google Gemini (ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯å¯¾å¿œ)</option>
              <option value="openai">OpenAI GPT-4o mini</option>
            </select>
          </div>
          <div>
            <label id="key-label" for="api-key-input" class="block text-sm font-semibold text-gray-700 mb-2">APIã‚­ãƒ¼</label>
            <input id="api-key-input" type="password" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
          </div>
      </div>

      <label class="block text-lg font-semibold text-gray-700 mb-3 mt-4">åˆ†æã—ãŸã„SNSã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
      <textarea id="comment-input" rows="4" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ä¾‹: ã‚ã®ä¼šç¤¾ã¯æ˜æ—¥å€’ç”£ã™ã‚‹ã€‚ã“ã‚Œã¯å†…éƒ¨æƒ…å ±ã ã€‚"></textarea>

      <button id="analyze-button" onclick="analyzeComment()" class="mt-4 w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
        <div id="button-text">ã‚³ãƒ¡ãƒ³ãƒˆã‚’åˆ†æã™ã‚‹</div>
        <div id="loading-spinner" class="hidden loader ml-2"></div>
      </button>
    </div>

    <!-- çµæœ -->
    <div id="results-area" class="hidden bg-white p-6 sm:p-8 rounded-xl container-box">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">åˆ†æçµæœ</h2>
      
      <div class="mb-4 flex items-center">
        <span class="text-gray-600 font-medium mr-4 text-lg">åˆ†é¡:</span>
        <span id="classification-display" class="classification-tag"></span>
      </div>
      
      <div class="mb-6">
        <h3 class="text-xl font-semibold text-gray-700 mb-2">æ ¹æ‹ ãƒ»åˆ†æ</h3>
        <div id="reasoning-display" class="text-gray-800 p-4 bg-gray-50 rounded-lg border border-gray-200 whitespace-pre-wrap"></div>
      </div>
      
      <!-- Geminiä½¿ç”¨æ™‚ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹æƒ…å ±æºã‚¨ãƒªã‚¢ -->
      <div id="sources-container" class="hidden mt-4 pt-4 border-t border-gray-200">
        <h3 class="text-xl font-semibold text-gray-700 mb-2 flex items-center">
            <svg class="w-5 h-5 mr-1 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.27a1 1 0 01.112.181l.088.22a1 1 0 01.037.289v9.544a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h7.828a1 1 0 01.707.293l3.586 3.586a1 1 0 01.293.707V7z"></path></svg>
            æƒ…å ±æº (ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯)
        </h3>
        <ul id="sources-list" class="space-y-2 text-sm ml-2"></ul>
      </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ -->
    <div id="error-message" class="hidden mt-8 p-4 bg-red-100 text-red-700 border border-red-200 rounded-lg container-box">
      <span class="font-bold">ã‚¨ãƒ©ãƒ¼: </span>
      <span id="error-text"></span>
    </div>

  </div>

<script>
const ENDPOINTS = {
  // Geminiã¯Canvasç’°å¢ƒã®ã‚­ãƒ¼è‡ªå‹•è£œå®Œã«ä¾å­˜
  gemini: "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent",
  openai: "https://api.openai.com/v1/chat/completions"
};

const CLASSIFICATION_MAP = {
    "çŠ¯ç½ªåŠ©é•·": { color: "color-crime", display: "çŠ¯ç½ªè¡Œç‚º/è„…è¿«" },
    "èª¹è¬—ä¸­å‚·": { color: "color-slander", display: "èª¹è¬—ä¸­å‚·/ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ" },
    "è™šå½æƒ…å ±": { color: "color-false", display: "ãƒ•ã‚§ã‚¤ã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹/èª¤æƒ…å ±" },
    "è‡ªå‹•æŠ•ç¨¿ï¼ˆbotï¼‰": { color: "color-bot", display: "Bot/è‡ªå‹•ç”Ÿæˆ" },
    "å®‰å…¨": { color: "color-safe", display: "å®‰å…¨/å•é¡Œãªã—" },
    "ä¸æ˜": { color: "color-safe", display: "ä¸æ˜/è§£æä¸èƒ½" }
};

// --- DOMè¦ç´  ---
const modelSelect = document.getElementById('model-select');
const apiKeyInput = document.getElementById('api-key-input');
const commentInput = document.getElementById('comment-input');
const analyzeButton = document.getElementById('analyze-button');
const buttonText = document.getElementById('button-text');
const loadingSpinner = document.getElementById('loading-spinner');
const resultsArea = document.getElementById('results-area');
const classificationDisplay = document.getElementById('classification-display');
const reasoningDisplay = document.getElementById('reasoning-display');
const sourcesContainer = document.getElementById('sources-container');
const sourcesList = document.getElementById('sources-list');
const errorMessage = document.getElementById('error-message');
const errorText = document.getElementById('error-text');
const keyLabel = document.getElementById('key-label');

// --- åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
modelSelect.addEventListener('change', updateAPIKeyPrompt);
document.addEventListener('DOMContentLoaded', updateAPIKeyPrompt);

/**
 * ãƒ¢ãƒ‡ãƒ«é¸æŠæ™‚ã®UIã¨APIã‚­ãƒ¼å…¥åŠ›ã®åˆ¶å¾¡
 */
function updateAPIKeyPrompt() {
    const model = modelSelect.value;
    const isGemini = model === 'gemini';
    
    // Canvasç’°å¢ƒã§è‡ªå‹•è£œå®Œã•ã‚Œã‚‹å ´åˆã¯APIã‚­ãƒ¼å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–
    const isCanvasAutoFilled = isGemini && typeof __initial_auth_token !== 'undefined';

    if (isGemini) {
        keyLabel.textContent = isCanvasAutoFilled ? "Google Gemini APIã‚­ãƒ¼ (è‡ªå‹•è£œå®Œã•ã‚Œã¾ã™)" : "Google Gemini APIã‚­ãƒ¼";
        apiKeyInput.placeholder = isCanvasAutoFilled ? "è‡ªå‹•è£œå®Œæ¸ˆã¿" : "AIzã§å§‹ã¾ã‚‹ã‚­ãƒ¼ã‚’å…¥åŠ›";
    } else {
        keyLabel.textContent = "OpenAI APIã‚­ãƒ¼";
        apiKeyInput.placeholder = "sk-ã§å§‹ã¾ã‚‹ã‚­ãƒ¼ã‚’å…¥åŠ›";
    }

    // ã‚­ãƒ¼å…¥åŠ›ã®ç„¡åŠ¹åŒ–/æœ‰åŠ¹åŒ–
    apiKeyInput.disabled = isCanvasAutoFilled;
    apiKeyInput.value = isCanvasAutoFilled ? 'CANVAS_AUTO_FILLED' : '';
}


/**
 * ã‚³ãƒ¡ãƒ³ãƒˆã‚’åˆ†æã—ã€çµæœã‚’UIã«è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
 */
async function analyzeComment() {
  const comment = commentInput.value.trim();
  const model = modelSelect.value;
  let apiKey = apiKeyInput.value.trim();
  
  if (!comment) return showError("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  
  const isGemini = model === 'gemini';
  
  // APIã‚­ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ã¨è¨­å®š
  if (isGemini) {
      // Geminiã¯Canvasç’°å¢ƒã®è‡ªå‹•è£œå®Œã«ä¾å­˜
      apiKey = ""; 
  } else if (!apiKey || apiKey === 'CANVAS_AUTO_FILLED') {
      return showError("OpenAIãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  }

  setLoading(true);
  try {
    let result = null;
    let rawData = null; 

    if (isGemini) {
        // Gemini: Google Search groundingã‚’æœ‰åŠ¹ã«ã—ã€JSONã‚¹ã‚­ãƒ¼ãƒã§æ§‹é€ åŒ–å¿œç­”ã‚’è¦æ±‚
        const body = {
            contents: [{ parts: [{ text: comment }] }],
            tools: [{ "google_search": {} }], // ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ã‚’æœ‰åŠ¹åŒ–
            systemInstruction: { parts: [{ text: generateSystemPrompt(model) }] },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        classification: { type: "STRING" },
                        reasoning: { type: "STRING" }
                    },
                    required: ["classification", "reasoning"]
                },
                model: "gemini-2.5-flash-preview-09-2025" 
            }
        };

        const res = await fetchWithExponentialBackoff(`${ENDPOINTS.gemini}?key=${apiKey}`, {
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify(body)
        });
        
        rawData = await res.json();
        
        const candidate = rawData.candidates?.[0];
        const jsonText = candidate?.content?.parts?.[0]?.text;
        
        if (!jsonText) {
            console.error("Gemini API Error:", rawData);
            throw new Error(rawData.error?.message || "Geminiã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™ã€‚");
        }
        
        result = JSON.parse(jsonText);
        result.isGrounded = true;
        result.groundingMetadata = candidate.groundingMetadata;

    } else {
        // OpenAI: JSONå½¢å¼ã§æ§‹é€ åŒ–å¿œç­”ã‚’è¦æ±‚
        const openaiModel = "gpt-4o-mini";
        const res = await fetchWithExponentialBackoff(ENDPOINTS.openai, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: openaiModel,
                messages: [{ role: "system", content: generateSystemPrompt(model) }, { role: "user", content: comment }],
                response_format: { type: "json_object" }
            })
        });
        
        if (!res.ok) {
            const text = await res.text();
            throw new Error(`OpenAI APIã‚¨ãƒ©ãƒ¼: ${res.status} ${text}`);
        }
        
        rawData = await res.json();
        const jsonText = rawData.choices?.[0]?.message?.content;

        if (!jsonText) {
            throw new Error("OpenAIã‹ã‚‰ã®çµæœè§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
        
        result = JSON.parse(jsonText);
        result.isGrounded = false;
    }

    if (!result.classification) throw new Error("çµæœã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚classificationãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");

    updateResultUI(result);

  } catch (err) {
    showError("åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
  } finally {
    setLoading(false);
  }
}

/**
 * æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ããƒ•ã‚§ãƒƒãƒé–¢æ•°ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼‰
 */
async function fetchWithExponentialBackoff(url, options, maxRetries = 5) {
    for (let attempt = 0; attempt < maxRetries; attempt++) {
        try {
            const response = await fetch(url, options);
            if (response.status !== 429 && response.ok) {
                return response;
            } else if (response.status === 429) {
                const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
                await new Promise(resolve => setTimeout(resolve, delay));
            } else {
                return response; // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚‚ãã®ã¾ã¾è¿”ã™
            }
        } catch (error) {
            if (attempt === maxRetries - 1) {
                throw error;
            }
            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
    throw new Error("APIå‘¼ã³å‡ºã—ãŒæœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’è¶…ãˆã¾ã—ãŸã€‚");
}

/**
 * AIãƒ¢ãƒ‡ãƒ«ã«æ¸¡ã™ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹
 */
function generateSystemPrompt(model) {
    const classifications = Object.keys(CLASSIFICATION_MAP).filter(c => c !== "ä¸æ˜").join('ã€ã€Œ');

    let prompt = `ã‚ãªãŸã¯SNSã‚³ãƒ¡ãƒ³ãƒˆã‚’ä»¥ä¸‹ã®åˆ†é¡ã§è­˜åˆ¥ã™ã‚‹AIãƒªã‚¹ã‚¯ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚
    åˆ†é¡: ã€Œ${classifications}ã€ã®ã„ãšã‚Œã‹ã€‚
    
    åˆ†æçµæœã¯ã€å¿…ãšJSONå½¢å¼ã§ {"classification": "åˆ†é¡å", "reasoning": "åˆ†é¡ã®æ ¹æ‹ ã¨åˆ†æçµæœã‚’æ—¥æœ¬èªã§è©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"} ã®ã¿è¿”ç­”ã—ã¦ãã ã•ã„ã€‚`;

    if (model === 'gemini') {
        prompt += `
        ã‚ãªãŸã¯Google Searchãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ã‚³ãƒ¡ãƒ³ãƒˆå†…ã®äº‹å®Ÿï¼ˆç‰¹ã«è™šå½æƒ…å ±ã‚„ãƒ•ã‚§ã‚¤ã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®å¯èƒ½æ€§ï¼‰ã‚’æ¤œè¨¼ã—ã€åˆ†æã«åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚`;
    }

    return prompt;
}

/**
 * åˆ†æçµæœã«åŸºã¥ã„ã¦UIã‚’æ›´æ–°ã™ã‚‹
 * @param {object} result - åˆ†æçµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function updateResultUI(result) {
    const classification = result.classification || "ä¸æ˜";
    const reasoning = result.reasoning || "ç†ç”±ãŒæä¾›ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚";
    const mapping = CLASSIFICATION_MAP[classification] || CLASSIFICATION_MAP["ä¸æ˜"];
    
    // 1. åˆ†é¡ã‚¿ã‚°ã®æ›´æ–°
    classificationDisplay.className = "classification-tag";
    classificationDisplay.classList.add(mapping.color);
    classificationDisplay.textContent = mapping.display;
    
    // 2. æ ¹æ‹ ã®æ›´æ–°
    reasoningDisplay.textContent = reasoning;
    
    // 3. æƒ…å ±æºã®æ›´æ–° (Geminiã‹ã¤ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆ)
    sourcesList.innerHTML = '';
    const isGeminiWithSources = result.isGrounded && result.groundingMetadata;

    if (isGeminiWithSources) {
        const sources = result.groundingMetadata.groundingAttributions
            .map(attr => ({
                uri: attr.web?.uri,
                title: attr.web?.title,
            }))
            .filter(source => source.uri && source.title);

        if (sources.length > 0) {
            sourcesContainer.classList.remove('hidden');
            sources.forEach(source => {
                const li = document.createElement('li');
                li.className = 'flex items-start';
                li.innerHTML = `
                    <svg class="w-4 h-4 mt-1 mr-2 text-blue-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11 3a1 1 0 100 2h3a1 1 0 100-2h-3zM3 11a1 1 0 102 0v-3a1 1 0 10-2 0v3zM11 15a1 1 0 100 2h3a1 1 0 100-2h-3zM5 11a1 1 0 100 2h3a1 1 0 100-2H5zM12 7a1 1 0 100-2h1a1 1 0 100 2h-1zM5 7a1 1 0 100 2h1a1 1 0 100-2H5zM12 11a1 1 0 100 2h1a1 1 0 100-2h-1zM5 15a1 1 0 100 2h1a1 1 0 100-2H5zM15 11a1 1 0 100 2h1a1 1 0 100-2h-1zM15 15a1 1 0 100 2h1a1 1 0 100-2h-1zM15 7a1 1 0 100 2h1a1 1 0 100-2h-1zM7 3a1 1 0 100 2h1a1 1 0 100-2H7zM7 15a1 1 0 100 2h1a1 1 0 100-2H7zM3 15a1 1 0 102 0v-1a1 1 0 10-2 0v1zM3 3a1 1 0 102 0v-1a1 1 0 10-2 0v1zM15 3a1 1 0 102 0v-1a1 1 0 10-2 0v1zM15 15a1 1 0 102 0v-1a1 1 0 10-2 0v1z"></path></svg>
                    <a href="${source.uri}" target="_blank" class="custom-link text-sm break-all">${source.title}</a>
                `;
                sourcesList.appendChild(li);
            });
        } else {
            sourcesContainer.classList.add('hidden');
        }
    } else {
        sourcesContainer.classList.add('hidden');
    }

    // 4. çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
    resultsArea.classList.remove("hidden");
    errorMessage.classList.add("hidden");
}

/**
 * ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
 */
function showError(msg){ 
    errorText.textContent = msg; 
    errorMessage.classList.remove("hidden"); 
    resultsArea.classList.add("hidden");
}

/**
 * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
 */
function setLoading(b){ 
    analyzeButton.disabled = b; 
    loadingSpinner.classList.toggle("hidden",!b); 
    buttonText.textContent = b ? "åˆ†æä¸­..." : "åˆ†æé–‹å§‹"; 
}
</script>
</body>
</html>

